{% extends '_main.html' %}

{% block title %}Movie - Bazarr{% endblock %}

{% block head %}
<style>
	#movieFanart {
		background-repeat: no-repeat;
		background-size: cover;
		background-position: top center;
		box-sizing: initial;
		margin-left: -32px;
		margin-top: -30px;
		padding: 2em;
	}

	#movieDetails {
		padding: 30px;
		background: rgba(0, 0, 0, 0.7);
		color: white;
		margin: -32px;
	}

	#moviePoster {
		width: 250px;
	}

	h1 {
		color: white;
	}

	span {
		margin-right: 0.5em;
	}
</style>
{% endblock head %}

{% block bcleft %}
<div class="">
	<button class="btn btn-outline" id="scan_button">
		<div><i class="fas fa-sync align-top text-themecolor text-center font-20" aria-hidden="true"></i></div>
		<div class="align-bottom text-themecolor small text-center">Scan Disk</div>
	</button>
	<button class="btn btn-outline" id="search_button">
		<div><i class="fas fa-search align-top text-themecolor text-center font-20" aria-hidden="true"></i></div>
		<div class="align-bottom text-themecolor small text-center">Search</div>
	</button>
</div>
{% endblock bcleft %}

{% block bcright %}
<div class="d-flex m-t-5 justify-content-end">
	<button class="btn btn-outline" id="edit_button">
		<div><i class="fas fa-wrench align-top text-themecolor text-center font-20" aria-hidden="true"></i></div>
		<div class="align-bottom text-themecolor small text-center">Edit Movie</div>
	</button>
</div>
{% endblock bcright %}

{% block body %}
<div class="container-fluid" id="movieFanart">
	<div class="row justify-content-md-center" id="movieDetails">
		<div class="col-sm-auto" id="moviePosterColumn">
			<img id="moviePoster" src="">
		</div>
		<div class="col">
			<div class="container-fluid">
				<div class="row">
					<h1><span id="movieTitle"></span></h1>
					<i class="far fa-clone" id="moviealternativeTitles" data-toggle="tooltip" data-placement="right" title="None" data-html="true"></i>
				</div>
				<div class="row">
					<h5><span id="movieAudioLanguage" class="badge badge-secondary"></span></h5>
					<h5><span id="movieMappedPath" class="badge badge-secondary"></span></h5>
				</div>
				<div class="row">
					<h5><span id="movieSubtitlesLanguages"></span></h5>
				</div>
				<div class="row">
					<h5><span id="movieHearingImpaired" class="badge badge-secondary"></span></h5>
					<h5><span id="movieForced" class="badge badge-secondary"></span></h5>
				</div>
				<div class="row">
					<span id="movieDescription"></span>
				</div>
			</div>
		</div>
	</div>
</div>
<div class="container-fluid">
	<!-- Bread crumb and right sidebar toggle -->
	<!-- ============================================================== -->
	<table id="movieSubtitles" class="table table-striped" style="width:100%">
		<thead>
		<tr>
			<th>Subtitles Path</th>
			<th>Language(s)</th>
		</tr>
		</thead>
	</table>
</div>

<div id="manualSearchModal" class="modal" tabindex="-1" role="dialog">
	<div class="modal-dialog modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title"><span id="movie_title_span"></span></h5><br>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<h6>Movie path is: <span id="movie_path_span" class="badge badge-secondary"></span>
					<br>Scenename is: <span id="movie_scenename_span" class="badge badge-secondary"></span></h6>
				<div class="container-fluid">
					<table id="search_result" class="table table-striped">
						<thead>
						<tr>
							<th style="text-align: left;">Score:</th>
							<th style="text-align: left;">Lang.:</th>
							<th style="text-align: left;">HI:</th>
							<th style="text-align: left;">Provider:</th>
							<th style="text-align: left;">Matching:</th>
							<th style="text-align: left;">Releases:</th>
							<th></th>
						</tr>
						</thead>
					</table>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
			</div>
		</div>
	</div>
</div>

<div id="uploadModal" class="modal" tabindex="-1" role="dialog">
	<div class="modal-dialog modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title"><span id="upload_movie_title_span"></span></h5><br>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<form class="form" name="upload_form" id="upload_form">
				<div class="modal-body">
					<div class="container-fluid">
						<div class="row">
							<div class="col-sm-2 text-right">
								Language
							</div>
							<div class="form-group col-sm-8 pl-sm-0">
								<select class="selectpicker" id="manual_language_select" name="language"></select>
							</div>
						</div>
						<div class="row">
							<div class="col-sm-2 text-right">
								Forced
							</div>
							<div class="form-group col-sm-1 pl-sm-0">
								<label class="custom-control custom-checkbox">
									<input type="checkbox" class="custom-control-input" id="forced_checkbox" name="forced">
									<span class="custom-control-label" for="forced_checkbox"></span>
								</label>
							</div>
						</div>
						<div class="row">
							<div class="col-sm-2 text-right">
								File
							</div>
							<div class="form-group col-sm-7 pl-sm-0">
								<div class="custom-file">
									<input type="file" class="custom-file-input" id="upload" name="upload">
									<label class="custom-file-label" for="upload">Choose file</label>
								</div>
							</div>
						</div>
					</div>

					<input type="hidden" id="upload_moviePath" name="moviePath" value="" />
					<input type="hidden" id="upload_sceneName" name="sceneName" value="" />
					<input type="hidden" id="upload_radarrId" name="radarrId" value="" />
					<input type="hidden" id="upload_title" name="title" value="" />
				</div>
				<div class="modal-footer">
					<button type="submit" id="upload_save_button" class="btn btn-primary">Save</button>
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
				</div>
			</form>
		</div>
	</div>
</div>

<div id="editModal" class="modal" tabindex="-1" role="dialog">
	<div class="modal-dialog modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title"><span id="edit_movie_title_span"></span></h5><br>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<form class="form" name="edit_form" id="edit_form">
				<div class="modal-body">
					<div class="container-fluid">
						<div class="row">
							<div class="col-sm-3 text-right">
								Audio Language
							</div>
							<div class="form-group col-sm-8 pl-sm-0">
								<span id="edit_audio_language_span"></span>
							</div>
						</div>
						<div class="row">
							<div class="col-sm-3 text-right">
								Subtitles Language(s)
							</div>
							<div class="form-group col-sm-8 pl-sm-0">
								<select class="selectpicker" id="edit_languages_select" name="languages" multiple data-live-search="true"></select>
							</div>
						</div>
						<div class="row">
							<div class="col-sm-3 text-right">
								Hearing-Impaired
							</div>
							<div class="form-group col-sm-1 pl-sm-0">
								<label class="custom-control custom-checkbox">
									<input type="checkbox" class="custom-control-input" id="hi_checkbox" name="hi">
									<span class="custom-control-label" for="hi_checkbox"></span>
								</label>
							</div>
						</div>
						<div class="row">
							<div class="col-sm-3 text-right">
								Forced
							</div>
							<div class="form-group col-sm-8 pl-sm-0">
								<select class="selectpicker" id="edit_forced_select" name="forced">
									<option value="False">False</option>
									<option value="True">True</option>
									<option value="Both">Both</option>
								</select>
							</div>
						</div>
					</div>

					<input type="hidden" id="edit_radarrId" name="radarrId" value="" />
				</div>
				<div class="modal-footer">
					<button type="submit" id="edit_save_button" class="btn btn-primary">Save</button>
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
				</div>
			</form>
		</div>
	</div>
</div>

<div id="movieHistoryModal" class="modal" tabindex="-1" role="dialog">
	<div class="modal-dialog modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title"><span id="movie_history_title_span"></span></h5><br>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<div class="container-fluid">
					<table id="movie_history_result" class="table table-striped">
						<thead>
						<tr>
							<th></th>
							<th style="text-align: left;">Language.:</th>
							<th style="text-align: left;">Provider:</th>
							<th style="text-align: left;">Score:</th>
							<th style="text-align: left;">Date:</th>
						</tr>
						</thead>
					</table>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
			</div>
		</div>
	</div>
</div>
{% endblock body %}

{% block tail %}
<script>
	// make the filename appear in upload file dialog once a file have been selected.
	$(document).ready(function () {
		document.querySelector('.custom-file-input').addEventListener('change',function(e){
			var fileName = document.getElementById("upload").files[0].name;
			var nextSibling = e.target.nextElementSibling;
			nextSibling.innerText = fileName;
		});

		$('#movies_nav').addClass("active");

		movieDetailsRefresh();
		getLanguages();
		getEnabledLanguages();
		console.log(movieDetails['subtitles']);
		var table = $('#movieSubtitles').DataTable({
			language: {
				zeroRecords: 'No Subtitles Found For This Movie'
			},
			"searching": false,
			"ordering": false,
			"paging": false,
			"info": false,
			"lengthChange": false,
			"data" : movieDetails['subtitles'],
			"columns" : [
				{ "data" : 1 },
				{ "data" : 0 }
			]
		});

		$('#episodes').on('click', '.remove_subtitles', function(e){
			$(this).tooltip('dispose');
			e.preventDefault();
			const values = {
				episodePath: $(this).attr("data-episodePath"),
				language: $(this).attr("data-language"),
				subtitlesPath: $(this).attr("data-subtitlesPath"),
				sonarrSeriesId: seriesDetails['sonarrSeriesId'],
				sonarrEpisodeId: $(this).attr("data-sonarrEpisodeId"),
				tvdbid: seriesDetails['tvdbId']
			};
			var cell = $(this).closest('td');
			$.ajax({
				url: "{{ url_for('api.episodessubtitlesdelete') }}",
				type: "DELETE",
				dataType: "json",
				data: values,
				beforeSend: function() {
					cell.html('<div class="spinner-border spinner-border-sm" role="status"><span class="sr-only">Loading...</span></div>');
				}
			});
		});

		$('#episodes').on('click', '.get_subtitle', function(e){
			$(this).tooltip('dispose');
			e.preventDefault();
			const values = {
				episodePath: $(this).attr("data-episodepath"),
				sceneName: $(this).attr("data-scenename"),
				language: $(this).attr("data-language"),
				hi: $(this).attr("data-hi"),
				forced: $(this).attr("data-forced"),
				sonarrSeriesId: seriesDetails['sonarrSeriesId'],
				sonarrEpisodeId: $(this).attr('data-sonarrepisodeid'),
				title: seriesDetails['title']
			};
			var cell = $(this).closest('td');
			$.ajax({
				url: "{{ url_for('api.episodessubtitlesdownload') }}",
				type: "POST",
				dataType: "json",
				data: values,
				beforeSend: function() {
					cell.html('<div class="spinner-border spinner-border-sm" role="status"><span class="sr-only">Loading...</span></div>');
				}
			});
		});

		$('#episodes').on('click', '.manual_search', function(e){
			e.preventDefault();
			$("#series_title_span").html(seriesDetails['title'] + ' - ' + $(this).data("season") + 'x' + $(this).data("episode") + ' - ' + $(this).data("episode_title"));
			$("#episode_path_span").html($(this).attr("data-episodePath"));
			$("#episode_scenename_span").html($(this).attr("data-sceneName"));

			episodePath = $(this).attr("data-episodePath");
			sceneName = $(this).attr("data-sceneName");
			language = $(this).attr("data-language");
			hi = seriesDetails['hearing_impaired'];
			forced = seriesDetails['forced'];
			sonarrSeriesId = seriesDetails['sonarrSeriesId'];
			sonarrEpisodeId = $(this).attr("data-sonarrEpisodeId");
			var languages = Array.from(seriesDetails['languages']);
			var is_pb = languages.includes('pb');
			var is_pt = languages.includes('pt');

			const values = {
				episodePath: episodePath,
				sceneName: sceneName,
				language: language,
				hi: hi,
				forced: forced,
				sonarrSeriesId: sonarrSeriesId,
				sonarrEpisodeId: sonarrEpisodeId,
				title: seriesDetails['title']
			};

			$('#search_result').DataTable( {
				destroy: true,
				language: {
					zeroRecords: 'No Subtitles Found For This Episode',
					processing: "Searching (possibly solving captcha)..."
				},
				paging: true,
				lengthChange: false,
				pageLength: 5,
				searching: false,
				ordering: false,
				processing: true,
				serverSide: false,
				ajax: {
					url: '{{ url_for('api.episodessubtitlesmanualsearch') }}',
					type: 'POST',
					data: values
				},
				columns: [
					{ data: 'score',
						render: function ( data ) {
							return data +'%';
						}
					},
					{ data: null,
						render: function ( data ) {
							if ( data.language === "pt" && is_pb === true && is_pt === false) {
								return 'pb'
							} else {
								return data.language
							}
						}
					},
					{ data: 'hearing_impaired' },
					{ data: null,
						render: function ( data ) {
							return '<a href="'+data.url+'" target="_blank">'+data.provider+'</a>';
						}
					},
					{ data: null,
						render: function ( data ) {
							const array_matches = data.matches;
							const array_dont_matches = data.dont_matches;
							let i;
							let text = '<div class="dropdown"><div class="btn-group dropdown"><button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="fas fa-check-circle" style="color: green;"></i> '+array_matches.length+'</button><div class="dropdown-menu" aria-labelledby="dropdownMenuButton">';
							for (i = 0; i < array_matches.length; i++) {
								text += '<a class="dropdown-item disabled" href="#">' + array_matches[i] + '</a>';
							}
							text += '</div>';
							text += '<div class="dropdown"><button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="fas fa-times-circle" style="color: red;"></i> '+array_dont_matches.length+'</button><div class="dropdown-menu" aria-labelledby="dropdownMenuButton">';
							for (i = 0; i < array_dont_matches.length; i++) {
								text += '<a class="dropdown-item disabled" href="#">' + array_dont_matches[i] + '</a>';
							}
							text += '</div></div></div>';
							return text;
						}
					},
					{ data: null,
						render: function ( data ) {
							const array_release_info = data.release_info;
							let i;
							let text = '<div class="dropdown"><button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="\tfas fa-comment-dots"></i> '+array_release_info.length+'</button><div class="dropdown-menu" aria-labelledby="dropdownMenuButton">';
							for (i = 0; i < array_release_info.length; i++) {
								text += '<a class="dropdown-item" href="#">' + array_release_info[i] + '</a>';
							}
							text += '</div></div>';
							return text;
						}
					},
					{ data: null,
						render: function ( data ) {
							return '<a href="" class="manual_download badge badge-secondary" data-episodePath="'+episodePath+'" data-sceneName="'+sceneName+'" data-sonarrEpisodeId='+sonarrEpisodeId+' data-subtitle="'+data.subtitle+'" data-provider="'+data.provider+'" data-language="'+data.language+'" data-forced="'+forced+'"><i class="fas fa-download" style="margin-right:0px" ></i></a>';
						}
					}
				]
			} );

			$('#manualSearchModal')
					.modal({
						focus: false
					});
		});

		$('#search_result').on('click', '.manual_download', function(e){
			e.preventDefault();
			const values = {
				episodePath: $(this).attr("data-episodepath"),
				sceneName: $(this).attr("data-scenename"),
				language: $(this).attr("data-language"),
				hi: seriesDetails['hearing_impaired'],
				forced: $(this).attr("data-forced"),
				provider: $(this).attr("data-provider"),
				subtitle: $(this).attr("data-subtitle"),
				sonarrSeriesId: seriesDetails['sonarrSeriesId'],
				sonarrEpisodeId: $(this).attr('data-sonarrepisodeid'),
				title: seriesDetails['title']
			};
			var cell = $(this).closest('td');
			$.ajax({
				url: "{{ url_for('api.episodessubtitlesmanualdownload') }}",
				type: "POST",
				dataType: "json",
				data: values,
				beforeSend: function() {
					cell.html('<div class="spinner-border spinner-border-sm" role="status"><span class="sr-only">Loading...</span></div>');
				},
				complete: function(data) {
					$('#manualSearchModal').modal('hide');
				}
			});
		});

		$('#episodes').on('click', '.upload_subtitle', function(e){
			e.preventDefault();
			$("#upload_series_title_span").html(seriesDetails['title'] + ' - ' + $(this).data("season") + 'x' + $(this).data("episode") + ' - ' + $(this).data("episode_title"));
			$('#upload_episodePath').val($(this).data("episodepath"));
			$('#upload_sceneName').val($(this).data("scenename"));
			$('#upload_sonarrSeriesId').val($(this).data("sonarrseriesid"));
			$('#upload_sonarrEpisodeId').val($(this).data("sonarrepisodeid"));
			$('#upload_title').val($(this).data("episode_title"));

			$('#manual_language_select').empty();
			$.each(enabledLanguages, function (i, item) {
				$('#manual_language_select').append('<option value="'+item.code2+'">'+item.name+'</option>');
			});
			$("#manual_language_select").selectpicker("refresh");

			$('#uploadModal')
					.modal({
						focus: false
					});
		});

		$('#upload_form').on('submit', function(e){
			e.preventDefault();
			var formdata = new FormData(document.getElementById("upload_form"));

			$.ajax({
				url: "{{ url_for('api.episodessubtitlesupload') }}",
				data: formdata,
				processData: false,
				contentType: false,
				type: 'POST',
				success: function(){
					$('#uploadModal').modal('hide');
				}
			});
		});

		$('#scan_button').on('click', function(e){
			e.preventDefault();
			$.ajax({
				url: "{{ url_for('api.episodesscandisk', seriesid=id) }}",
				type: 'GET',
				beforeSend: function() {
					$('#scan_button').find("i").addClass('fa-spin');
				},
				complete: function() {
					$('#scan_button').find("i").removeClass('fa-spin');
				}
			});
		});

		$('#search_button').on('click', function(e){
			e.preventDefault();
			$.ajax({
				url: "{{ url_for('api.episodessearchmissing', seriesid=id) }}",
				type: 'GET',
				beforeSend: function() {
					$('#search_button').find("i").addClass('fa-spin');
				},
				complete: function() {
					$('#search_button').find("i").removeClass('fa-spin');
				}
			});
		});

		$('#edit_button').on('click', function(e){
			e.preventDefault();
			$("#edit_series_title_span").html(seriesDetails['title']);
			$("#edit_audio_language_span").text(seriesDetails['audio_language']['name']);
			$('#edit_sonarrSeriesId').val(seriesDetails['sonarrSeriesId']);


			$('#edit_languages_select').empty();
			if ('{{settings.general.single_language}}' === 'True') {
				$('#edit_languages_select').selectpicker({maxOptions: 1});
				$('#edit_languages_select').append('<option value="None">None</option>');
			}
			$.each(enabledLanguages, function (i, item) {
				$('#edit_languages_select').append('<option value="'+item.code2+'">'+item.name+'</option>');
			});
			$("#edit_languages_select").selectpicker("refresh");
			var selected_languages = Array();
			$.each(Array.from(seriesDetails['languages']), function (i, item) {
				selected_languages.push(item.code2);
			});
			$('#edit_languages_select').selectpicker('val', selected_languages);
			$('#hi_checkbox').prop('checked', (seriesDetails['hearing_impaired'] === 'True'));
			$('#edit_forced_select').val(seriesDetails['forced']).change();

			$('#editModal')
					.modal({
						focus: false
					});
		});

		$('#edit_form').on('submit', function(e){
			e.preventDefault();
			var formdata = new FormData(document.getElementById("edit_form"));

			$.ajax({
				url: "{{ url_for('api.series') }}?seriesid={{id}}",
				data: formdata,
				processData: false,
				contentType: false,
				type: 'POST',
				success: function(){
					seriesDetailsRefresh();
					$('#editModal').modal('hide');
				}
			});
		});

		$('#uploadModal').on('hidden.bs.modal', function () {
			$(this).find('form')[0].reset();
		});

		events.on('event', function(event) {
			var event_json = JSON.parse(event);
			if (event_json.series === {{id}}) {
				if (event_json.type === 'series' && event_json.action === 'update' && event_json.episode == null) {
					seriesDetailsRefresh();
				}

				if (event_json.type === 'episode' && event_json.action === 'insert') {
					$.ajax({
						url: "{{ url_for('api.episodes') }}?seriesid=" + event_json.series + "&episodeid=" + event_json.episode,
						success: function (data) {
							if (data.data.length) {
								$('#episodes').DataTable().rows.add(data.data);
								$('#episodes').DataTable().columns.adjust().draw(false);
								$('[data-toggle="tooltip"]').tooltip({html: true});
							}
						}
					})
				} else if (event_json.type === 'episode' && event_json.action === 'update') {
					var rowId = $('#episodes').DataTable().row('#row_' + event_json.episode);
					if (rowId.length) {
						$.ajax({
							url: "{{ url_for('api.episodes') }}?seriesid=" + event_json.series + "&episodeid=" + event_json.episode,
							success: function (data) {
								if (data.data.length) {
									$('#episodes').DataTable().row(rowId).data(data.data[0]);
									$('[data-toggle="tooltip"]').tooltip({html: true});
								}
							}
						})
					}
				} else if (event_json.type === 'episode' && event_json.action === 'delete') {
					var rowId = $('#episodes').DataTable().row('#row_' + event_json.episode);
					if (rowId.length) {
						$('#episodes').DataTable().row(rowId).remove();
						$('#episodes').DataTable().columns.adjust().draw(false);
						$('[data-toggle="tooltip"]').tooltip({html: true});
					}
				}
			}
		});

		$('#episodes').on('click', '.episode_history', function(e){
			$(this).tooltip('dispose');
			e.preventDefault();

			$("#episode_history_title_span").html(seriesDetails['title'] + ' - ' + $(this).data("season") + 'x' + $(this).data("episode") + ' - ' + $(this).data("episodetitle"));

			sonarrEpisodeId = $(this).data("sonarrepisodeid");

			$('#episode_history_result').DataTable( {
				destroy: true,
				language: {
					zeroRecords: 'No History Records Found For This Episode'
				},
				paging: true,
				lengthChange: false,
				pageLength: 5,
				searching: true,
				ordering: false,
				processing: false,
				serverSide: false,
				ajax: {
					url: '{{ url_for( 'api.episodeshistory' )}}?episodeid=' + sonarrEpisodeId
				},
				columns: [
					{ data: 'action',
						"render": function(data) {
							if (data === 0) {return "<i class='fas fa-trash' title='Subtitle file has been erased.' data-toggle='tooltip' data-placement='right'></i>";}
							else if (data === 1) {return "<i class='fas fa-download' title='Subtitle file has been downloaded.' data-toggle='tooltip' data-placement='right'></i>";}
							else if (data === 2) {return "<i class='fas fa-user' title='Subtitle file has been manually downloaded.' data-toggle='tooltip' data-placement='right'></i>";}
							else if (data === 3) {return "<i class='fas fa-recycle' title='Subtitle file has been upgraded.' data-toggle='tooltip' data-placement='right'></i>";}
							else if (data === 4) {return "<i class='fas fa-cloud-upload-alt' title='Subtitle file has been manually uploaded.' data-toggle='tooltip' data-placement='right'></i>";}
						}},
					{ data: 'language' },
					{ data: 'provider' },
					{ data: 'score'},
					{ data: 'timestamp' }
				]
			} );

			$('#episodeHistoryModal')
					.modal({
						focus: false
					});
		});
	});

	function movieDetailsRefresh() {
		$.ajax({
			url: "{{ url_for('api.movies') }}?radarrid={{id}}"
		}).done(function (data) {
			movieDetails = data.data[0];
			$(document).prop('title', movieDetails['title'] + ' - Bazarr');
			$('#movieFanart').css('background-image', "url('{{ url_for('image_proxy_movies', url='MediaCover/'+id+'/fanart.jpg') }}')");
			$('#moviePoster').attr("src", "{{ url_for('image_proxy_movies', url='MediaCover/'+id+'/poster-250.jpg') }}");
			$('#movieTitle').text(movieDetails['title']);

			if (movieDetails['alternativeTitles'].length > 0) {
				$('#moviealternativeTitles').attr("data-original-title", "<b>Alternative Titles:</b><br>" + movieDetails['alternativeTitles']);
			} else {
				$('#moviealternativeTitles').hide();
			}

			$('#movieAudioLanguage').text(movieDetails['audio_language'].name);
			$('#movieMappedPath').text(movieDetails['mapped_path']);

			var languages = '';
			if (movieDetails['languages'] !== 'None') {
				movieDetails['languages'].forEach(appendFunc);
			}

			function appendFunc(value) {
				languages = languages + '<span class="badge badge-secondary" data-toggle="tooltip" data-placement="right" title="' + value.name + '">' + value.code2 + '</span> ';
			}

			$('#movieSubtitlesLanguages').html(languages);
			$('#movieHearingImpaired').text('Hearing-Impaired: ' + movieDetails['hearing_impaired']);
			$('#movieForced').text('Forced: ' + movieDetails['forced']);
			$('#movieDescription').text(movieDetails['overview']);

			$('[data-toggle="tooltip"]').tooltip({html: true});
		});
	}

	function getLanguages() {
		$.ajax({
			url: "{{ url_for('api.languages') }}?enabled=false",
			success:function(data) {
				availableLanguages = data;
			}
		});
	}

	function getEnabledLanguages() {
		$.ajax({
			url: "{{ url_for('api.languages') }}?enabled=true",
			success:function(data) {
				enabledLanguages = data;
			}
		});
	}
</script>
{% endblock tail %}
