{% extends '_main.html' %}

{% block title %}Import (Series) - Bazarr{% endblock %}

{% block bcleft %}
    <div id="buttons"></div>
{% endblock bcleft %}

{% block bcright %}

{% endblock bcright %}

{% block body %}
    <table id="import_series" class="table table-striped" style="width:100%">
        <thead>
        <tr>
            <th></th>
            <th>Directory</th>
            <th>Monitor</th>
            <th>Language Profile</th>
            <th>Series</th>
        </tr>
        </thead>
    </table>

    <nav id="edit_bar" class="navbar fixed-bottom navbar-dark bg-dark">
        <div class="form-check form-check-inline">
            <div class="form-group" style="margin-bottom: 0px;">
                <label for="language_profile_select">Monitor: </label>
                <select class="selectpicker" id="monitor_select" name="monitor_select"><option value="1">True</option><option value="0">False</option></select>
            </div>
        </div>
        <div class="form-check form-check-inline">
            <div class="form-group" style="margin-bottom: 0px;">
                <label for="language_profile_select">Language Profile: </label>
                <select class="selectpicker" id="language_profile_select" name="language_profile_select"></select>
            </div>
        </div>
        <div class="form-check form-check-inline">
            <button type="submit" class="btn btn-info" id="import_button">Import <span id="selected_series_count">0</span> Series</span></button>
        </div>
    </nav>
{% endblock body %}

{% block tail %}
    <script>
        $(document).ready(function () {
            $('#series_nav').addClass("active");
            $('#series_import_nav').addClass("active");

            var table = $('#import_series').DataTable({
                language: {
                    zeroRecords: 'No Directories In This Root Directory'
                },
                searching: false,
                ordering: false,
                lengthChange: false,
                responsive: true,
                paging: false,
                info: false,
                ajax: "{{ url_for('api.getseries') }}?root_dir={{id}}",
                columnDefs: [{
                    orderable: false,
                    className: 'select-checkbox',
                    targets: 0
                }],
                select: {
                    style: 'multi',
                    selector: 'td:first-child'
                },
                columns: [
                    {defaultContent: ""},
                    {
                        data: "directory",
                        width: "30%"
                    },
                    {
                        data: null,
                        render: function () {
                            return '<select class="monitor selectpicker" data-width="100%"><option value="1">True</option><option value="0">False</option></select>';
                        },
                        width: "20%"
                    },
                    {
                        data: null,
                        render: function () {
                            return '<select class="languages_profiles selectpicker" data-width="100%"><option ""> </option></select>';
                        },
                        width: "20%"
                    },
                    {
                        data: null,
                        render: function (data) {
                            return '<select id="series_' + data.id + '" class="series_matches selectpicker" data-directory="' + data.directory + '" data-width="100%"></select>';
                        },
                        width: "30%"
                    }
                ],
                initComplete: function() {
                    $('.monitor').selectpicker("refresh");

                    getLanguagesProfiles();

                    $('.series_matches').each( function() {
                        getSeries($(this).attr('data-directory'), $(this).attr('id'));
                    })
                }
            });

            new $.fn.dataTable.Buttons(table, {
                buttons: [
                    {
                        extend: 'selectAll',
                        text: '<div><i class="far fa-check-square align-top text-themecolor text-center font-20" aria-hidden="true"></i></div>\n' +
                            '            <div class="align-bottom text-themecolor small text-center">Select ALL</div>'
                    },
                    {
                        extend: 'selectNone',
                        text: '<div><i class="far fa-square align-top text-themecolor text-center font-20" aria-hidden="true"></i></div>\n' +
                            '            <div class="align-bottom text-themecolor small text-center nowrap">Deselect ALL</div>'
                    }]
            });

            table.buttons().container().appendTo('#buttons');

            var btns = $('.dt-button');
            btns.addClass('btn btn-outline');
            btns.removeClass('dt-button');

            $('#monitor_select').prop('disabled', true);
            $('#monitor_select').selectpicker('refresh');
            $('#language_profile_select').prop('disabled', true);
            $('#language_profile_select').selectpicker('refresh');
            $('#import_button').prop('disabled', true);
            $('#import_button').addClass('disabled');
            $('#import_button').css('cursor', 'not-allowed');

            table.on('select', function () {
                $('#monitor_select').prop('disabled', false);
                $('#monitor_select').selectpicker('refresh');
                $('#language_profile_select').prop('disabled', false);
                $('#language_profile_select').selectpicker('refresh');
                $('#import_button').prop('disabled', false);
                $('#import_button').removeClass('disabled');
                $('#import_button').css('cursor', 'pointer');
                $('#selected_series_count').text(table.rows('.selected').count());
            });

            table.on('deselect', function () {
                if (table.rows('.selected').count() === 0) {
                    $('#monitor_select').prop('disabled', true);
                    $('#monitor_select').selectpicker('refresh');
                    $('#language_profile_select').prop('disabled', true);
                    $('#language_profile_select').selectpicker('refresh');
                    $('#import_button').prop('disabled', true);
                    $('#import_button').addClass('disabled');
                    $('#import_button').css('cursor', 'not-allowed');
                }
                $('#selected_series_count').text(table.rows('.selected').count());
            });

            $('#monitor_select').on("changed.bs.select", function() {
                $.each(table.rows('.selected').nodes().to$(), function () {
                    $(this).find('select.monitor').selectpicker('val', $('#monitor_select').selectpicker('val'));
                    $(this).find('select.monitor').selectpicker("refresh");
                })
            });

            $('#language_profile_select').on('changed.bs.select', function() {
                $.each(table.rows('.selected').nodes().to$(), function () {
                    $(this).find('select.languages_profiles').prop('selectedIndex', $('#language_profile_select').selectpicker('val')-1);
                    $(this).find('select.languages_profiles').selectpicker("refresh");
                })
            });
        });

        function getSeries(directory, id) {
            $.ajax({
                url: "{{ url_for('api.getseriesmatch') }}?directory=" + directory,
                success: function (data) {
                    $('#'+id).empty();
                    $.each(data.data, function (i, item) {
                        $('#'+id).append('<option value="' + item.tmdbId + '" data-subtext="(' + item.year + ')">' + item.title + '</option>');
                    });
                    $('#'+id).selectpicker({
                        'showSubtext': true,
                        'noneSelectedText': 'No Matches'
                    });
                    $('#'+id).selectpicker("refresh");
                }
            });
        }

        function getLanguagesProfiles() {
            $.ajax({
                url: "{{ url_for('api.languagesprofiles') }}",
                success: function (data) {
                    let options = '';
                    $.each(data.data, function () {
                        options += '<option value="' + this.id + '">' + this.name + '</option>';
                    });
                    $('.languages_profiles, #language_profile_select').empty();
                    $('.languages_profiles, #language_profile_select').append(options);
                    $('.languages_profiles, #language_profile_select').selectpicker("refresh");
                }
            });
        }
    </script>
{% endblock tail %}
