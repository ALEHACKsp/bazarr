{% extends '_main.html' %}

{% block title %}Series - Bazarr{% endblock %}
{% block head %}
    <style>
        #fondblanc {
            background-color: #ffffff;
            border-radius: 0;
            box-shadow: 0 0 5px 5px #ffffff;
            margin-top: 32px;
            margin-bottom: 3em;
            padding: 2em 3em 2em 3em;
            overflow-x: auto;
        }

        #tableseries {
            padding-top: 1em;
        }

        #divdetails {
            min-height: 250px;
        }

        .ui.progress:last-child {
            margin: 0 0 0 !important;
        }

        .ui.progress .bar > .progress {
            right: auto;
            left: .5em;
            color: rgba(0, 0, 0, 0.60);
        }
    </style>
{% endblock head %}
{% block body %}
    <div class="page-wrapper">
        <div id="fondblanc" class="container-fluid">
            <div class="ui basic buttons">
                <button id="serieseditor" class="ui button"><i class="configure icon"></i>Series Editor</button>
            </div>
            <table id="tableseries" class="ui very basic selectable stackable table">
                <thead>
                <tr>
                    <th>Name</th>
                    <th>Path</th>
                    <th>Audio Language</th>
                    <th>Subtitle Language(s)</th>
                    <th>Hearing-Impaired</th>
                    <th>Forced</th>
                    <th class="two wide">Subtitles</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                {% for row in rows %}
                    <tr class="selectable">
                        <td><a href="{{ base_url }}episodes/{{ row['sonarrSeriesId'] }}">{{ row['title'] }}</a></td>
                        <td>
                            {% if os.path.isdir(row['path']) %}
                                <span data-tooltip="This path seems to be valid." data-inverted=""
                                      data-position="top left"><i
                                        class="checkmark icon"></i></span>
                            {% else %}
                                <span data-tooltip="This path doesn't seem to be valid." data-inverted=""
                                      data-position="top left"><i class="warning sign icon"></i></span>
                            {% endif %}
                            {{ row['path'] }}
                        </td>
                        <td>{{ row['audio_language'] }}</td>
                        <td>
                            {% set subs_languages = ast.literal_eval(str(row['languages'])) %}
                            {% if subs_languages != None %}
                                {% for subs_language in subs_languages %}
                                    <div class="ui tiny label">{{ subs_language }}</div>
                                {% endfor %}
                            {% endif %}
                        </td>
                        <td>{% if row['hearing_impaired'] == None %}
                        {% else %}
                            {{ row['hearing_impaired']|safe }}
                        {% endif %}
                        </td>
                        <td>{{ row['forced'] }}</td>
                        <td>
                            {% set total_subs = 0 %}
                            {% set missing_subs = 0 %}
                            {% if total_subtitles_list %}
                                {% for total_subtitles in total_subtitles_list %}
                                    {% if total_subtitles['sonarrSeriesId'] == row['sonarrSeriesId'] %}
                                        {% set total_subs = total_subtitles['missing_subtitles'] %}
                                    {% endif %}
                                {% endfor %}
                                {% for missing_subtitles in missing_subtitles_list %}
                                    {% if missing_subtitles['sonarrSeriesId'] == row['sonarrSeriesId'] %}
                                        {% set missing_subs = missing_subtitles['missing_subtitles'] %}
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                            <div class="ui progress" data-value="{{ total_subs - missing_subs }}"
                                 data-total="{{ total_subs }}">
                                <div class="bar">
                                    <div class="progress"></div>
                                </div>
                            </div>
                        </td>
                        <td {{ "style='background-color: #e8e8e8;'" if row['hearing_impaired']|safe == None else "" }}>
                            {% set subs_languages_list = [] %}
                            {% if subs_languages != None %}
                                {% for subs_language in subs_languages %}
                                    {{ subs_languages_list.append(subs_language) }}
                                {% endfor %}
                            {% endif %}
                            <div class="config ui inverted basic compact icon" data-tooltip="Edit Series"
                                 data-inverted=""
                                 data-position="top right" data-no="{{ row['sonarrSeriesId'] }}"
                                 data-title="{{ row['title'] }}" data-poster="{{ row['poster'] }}"
                                 data-languages="{{ subs_languages_list|safe }}"
                                 data-hearing-impaired="{{ row['hearing_impaired'] }}" data-forced="{{ row['forced'] }}"
                                 data-audio="{{ row['audio_language'] }}">
                                <i class="ui black configure icon"></i>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>

        </div>

        <div class="ui small modal">
            <i class="close icon"></i>
            <div class="header">
                <div id="series_title"></div>
            </div>
            <div class="content">
                <form name="series_form" id="series_form" action="" method="post" class="ui form">
                    <div id="divdetails" class="ui grid">
                        <div class="four wide column">
                            <img id="series_poster" class="ui image" src="">
                        </div>
                        <div class="twelve wide column">
                            <div class="ui grid">
                                <div class="middle aligned row">
                                    <div class="right aligned five wide column">
                                        <label>Audio Language</label>
                                    </div>
                                    <div class="nine wide column">
                                        <div id="series_audio_language"></div>
                                    </div>
                                </div>
                                <div class="middle aligned row">
                                    <div class="right aligned five wide column">
                                        <label>Subtitle Language(s)</label>
                                    </div>
                                    <div class="nine wide column">
                                        <select name="languages" id="series_languages"
                                                {{ 'multiple="" ' if single_language|safe == False else '' }}class="ui fluid selection dropdown">
                                            <option value="">Languages</option>
                                            {% if single_language %}
                                                <option value="None">None</option>
                                            {% endif %}
                                            {% for language in languages %}
                                                <option value="{{ language['code2'] }}">{{ language['name'] }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="middle aligned row">
                                    <div class="right aligned five wide column">
                                        <label>Hearing-Impaired</label>
                                    </div>
                                    <div class="nine wide column">
                                        <div id="series_hearing-impaired_div" class="ui toggle checkbox">
                                            <input name="hearing_impaired" id="series_hearing-impaired" type="checkbox">
                                            <label></label>
                                        </div>
                                    </div>
                                </div>
                                <div class="middle aligned row">
                                    <div class="right aligned five wide column">
                                        <label>Forced</label>
                                    </div>
                                    <div class="nine wide column">
                                        <select name="forced" id="series_forced" class="ui fluid selection dropdown">
                                            <option value="False">False</option>
                                            <option value="True">True</option>
                                            <option value="Both">Both</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="actions">
                <button class="ui cancel button">Cancel</button>
                <button type="submit" name="save" value="save" form="series_form" class="ui blue approve button">Save
                </button>
            </div>
        </div>

    </div>
{% endblock body %}
{% block tail %}


    <script>
        if (sessionStorage.scrolly) {
            $(window).scrollTop(sessionStorage.scrolly);
            sessionStorage.clear();
        }

        $('a, button:not(.cancel)').on('click', function () {
            $('#loader').addClass('active');
        });

        $('#serieseditor').on('click', function () {
            window.location = '{{base_url}}serieseditor';
        });

        {#$('.modal')#}
        {#    .modal({#}
        {#        autofocus: false#}
        {#    });#}

        $('.config').on('click', function () {
            sessionStorage.scrolly = $(window).scrollTop();

            $('#series_form').attr('action', '{{base_url}}edit_series/' + $(this).data("no"));

            $("#series_title").html($(this).data("title"));
            $("#series_poster").attr("src", "{{base_url}}image_proxy" + $(this).data("poster"));

            $("#series_audio_language").html($(this).data("audio"));

            $('#series_languages').dropdown('clear');
            const languages_array = eval($(this).data("languages"));
            $('#series_languages').dropdown('set selected', languages_array);

            $('#series_forced').dropdown('clear');
            $('#series_forced').dropdown('set selected', $(this).data("forced"));

            if ($(this).data("hearing-impaired") === "True") {
                $("#series_hearing-impaired_div").checkbox('check');
            } else {
                $("#series_hearing-impaired_div").checkbox('uncheck');
            }

            $('.small.modal').modal('show');
        });

        $('.progress').progress({
            label: 'ratio',
            text: {
                ratio: '{value} / {total}'
            },
            showActivity: false
        });

        $(".progress").each(function () {
            if ($(this).progress('is complete') !== true) {
                $(this).addClass('yellow');
            }
            if ($(this).progress('get total') == 0) {
                $(this).progress('update progress', '99');
                $(this).addClass('grey disabled');
                $(this).progress('set bar label', '0 / 0');
            }
        });
    </script>
{% endblock tail %}
